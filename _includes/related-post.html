{% assign hasSimilar = '' %}
{% for post in site.posts  %}
{% assign postHasSimilar = false %}
{% for tag in post.tags %}
{% for thisTag in page.tags %}
{% if postHasSimilar == false and hasSimilar.size < 6 and post != page and tag == thisTag %}
{% if hasSimilar.size == 0 %}
<div class="related-posts">
    <h3>Related Posts</h3>
    <br/>
    <ul>
        {% endif %}
        <li class="relatedPost">
            <a href="{{ site.url }}{{ post.url }}">{{ post.title }}
                {% if post.series %}
                (Series: {{ post.series }})
                {% endif %}
            </a>
        </li>
        {% capture hasSimilar %}{{ hasSimilar }}*{% endcapture %}
        {% assign postHasSimilar = true %}
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% endfor %}
        {% if hasSimilar.size > 0 %}
    </ul>
</div>
{% endif %}
